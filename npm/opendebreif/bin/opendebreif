#!/usr/bin/env node

const childProcess = require("child_process");
const fs = require("fs");
const path = require("path");
const os = require("os");

function run(target, args) {
  const result = childProcess.spawnSync(target, args, {
    stdio: "inherit",
  });
  if (result.error) {
    console.error(result.error.message);
    process.exit(1);
  }
  process.exit(result.status ?? 0);
}

const platform = os.platform();

if (platform !== "darwin") {
  console.error("opendebreif currently only supports macOS");
  console.error("Linux and Windows support coming soon!");
  process.exit(1);
}

// Always use arm64 binary (works on Intel via Rosetta 2)
const pkgName = "opendebreif-darwin-arm64";
const binaryName = "opendebreif";

// Find the binary in node_modules
function findBinary(startDir) {
  let current = startDir;
  while (true) {
    const candidate = path.join(current, "node_modules", pkgName, "bin", binaryName);
    if (fs.existsSync(candidate)) {
      return candidate;
    }
    const parent = path.dirname(current);
    if (parent === current) break;
    current = parent;
  }
  return null;
}

const scriptDir = path.dirname(fs.realpathSync(__filename));
const binary = findBinary(scriptDir);

if (!binary) {
  console.error(`Could not find ${pkgName} binary.`);
  console.error(`Try reinstalling: npm install -g opendebreif`);
  process.exit(1);
}

run(binary, process.argv.slice(2));
