name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g. 0.2.3)'
        required: true

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Get version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Sync version
        run: |
          cat > src/version.ts << EOF
          export const VERSION = "${{ env.VERSION }}";
          export const PACKAGE_NAME = "opendebrief";
          EOF

      - name: Build binary
        run: |
          mkdir -p dist/darwin-arm64
          bun build src/cli.ts --compile --outfile=dist/darwin-arm64/opendebrief

      - name: Compile Swift recorder
        run: |
          swiftc -O -o dist/darwin-arm64/recorder native/recorder.swift

      - name: Create archive for GitHub Release
        run: |
          cd dist/darwin-arm64
          zip -r ../opendebrief-v${{ env.VERSION }}-darwin-arm64.zip .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-darwin-arm64
          path: dist/opendebrief-v${{ env.VERSION }}-darwin-arm64.zip

  release:
    needs: [build-macos]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: release-*
          path: artifacts
          merge-multiple: true

      - name: Get version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Upload to Release
        run: |
          gh release upload v${{ env.VERSION }} artifacts/*.zip --clobber || \
          gh release create v${{ env.VERSION }} artifacts/*.zip --title "v${{ env.VERSION }}" --generate-notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


