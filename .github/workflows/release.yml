name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [arm64, x64]
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Get version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Sync version
        run: |
          cat > src/version.ts << EOF
          export const VERSION = "${{ env.VERSION }}";
          export const PACKAGE_NAME = "opendebreif";
          EOF

      - name: Build binary
        run: |
          mkdir -p dist/darwin-${{ matrix.arch }}
          bun build src/cli.ts --compile --target=bun-darwin-${{ matrix.arch }} --outfile=dist/darwin-${{ matrix.arch }}/opendebreif

      - name: Compile Swift recorder
        run: |
          swiftc -O -o dist/darwin-${{ matrix.arch }}/recorder native/recorder.swift

      - name: Create archive for GitHub Release
        run: |
          cd dist/darwin-${{ matrix.arch }}
          zip -r ../opendebreif-v${{ env.VERSION }}-darwin-${{ matrix.arch }}.zip .

      - name: Prepare npm package
        run: |
          mkdir -p npm/opendebreif-darwin-${{ matrix.arch }}/bin
          cp dist/darwin-${{ matrix.arch }}/opendebreif npm/opendebreif-darwin-${{ matrix.arch }}/bin/
          cp dist/darwin-${{ matrix.arch }}/recorder npm/opendebreif-darwin-${{ matrix.arch }}/bin/
          
          # Update package.json version
          cd npm/opendebreif-darwin-${{ matrix.arch }}
          cat > package.json << EOF
          {
            "name": "opendebreif-darwin-${{ matrix.arch }}",
            "version": "${{ env.VERSION }}",
            "description": "opendebreif binary for macOS ${{ matrix.arch }}",
            "author": "Shkumbin Hasani",
            "license": "MIT",
            "repository": {
              "type": "git",
              "url": "https://github.com/shkumbinhasani/opendebreif.git"
            },
            "os": ["darwin"],
            "cpu": ["${{ matrix.arch }}"],
            "files": ["bin"]
          }
          EOF

      - name: Upload GitHub Release artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-darwin-${{ matrix.arch }}
          path: dist/opendebreif-v${{ env.VERSION }}-darwin-${{ matrix.arch }}.zip

      - name: Upload npm package artifact
        uses: actions/upload-artifact@v4
        with:
          name: npm-darwin-${{ matrix.arch }}
          path: npm/opendebreif-darwin-${{ matrix.arch }}

  release:
    needs: [build-macos]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: release-*
          path: artifacts
          merge-multiple: true

      - name: Get version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*.zip
          generate_release_notes: true
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-npm:
    needs: [build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Get version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: Download npm artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: npm-*
          path: npm-packages

      - name: Publish darwin-arm64
        run: |
          cd npm-packages/npm-darwin-arm64
          npm publish --access public --provenance

      - name: Publish darwin-x64
        run: |
          cd npm-packages/npm-darwin-x64
          npm publish --access public --provenance

      - name: Publish main package
        run: |
          # Update main package version
          cd npm/opendebreif
          cat > package.json << EOF
          {
            "name": "opendebreif",
            "version": "${{ env.VERSION }}",
            "description": "Record any meeting. Transcribe it. Know who said what.",
            "author": "Shkumbin Hasani",
            "license": "MIT",
            "repository": {
              "type": "git",
              "url": "https://github.com/shkumbinhasani/opendebreif.git"
            },
            "homepage": "https://github.com/shkumbinhasani/opendebreif",
            "keywords": ["meeting", "transcription", "recording", "audio", "macos", "tui", "cli", "whisper", "openai"],
            "bin": {
              "opendebreif": "bin/opendebreif"
            },
            "files": ["bin"],
            "os": ["darwin"],
            "optionalDependencies": {
              "opendebreif-darwin-arm64": "${{ env.VERSION }}",
              "opendebreif-darwin-x64": "${{ env.VERSION }}"
            }
          }
          EOF
          npm publish --access public --provenance
